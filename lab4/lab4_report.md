University: [ITMO University](https://itmo.ru/ru/)
Faculty: [FICT](https://fict.itmo.ru)
Course: [Network programming](https://github.com/itmo-ict-faculty/network-programming)
Year: 2022/2023
Group: K34212
Author: Leshkov Roman Sergeevich
Lab: Lab4
Date of create: 18.11.2022
Date of finished: 18.01.2023

Цель работы: 

Изучить синтаксис языка программирования P4 и выполнить 2 задания обучающих задания от Open network foundation для ознакомления на практике с P4.

Ход работы:

1. Подготовка

Учебная среда располагается в виртуальной машине, чтобы поставить виртуальную машину на компьютере должны быть установлены VirtualBox и Vagrant. На Windows установщики скачиваются с оффициальных сайтов (для скачивания Vagrant был использован VPN (BrightVPN)).

C github p4lang загружается репозиторий tutorials. После загрузки в терминале в папке _vm-ubuntu-20.04_ запускается vagrant:

    vagrant up

При размещнии в папке, путь к которой содержит кириллицу, может показать ошибка:
    
    2.7.0/json/common.rb:156:in `initialize': negative string size (or size too big) (ArgumentError)
    
Чтобы ее исправить достаточно изменить путь к папке на путь без кириллицы и удалить папку .vagrant.d в папке пользователя, после повторно выполнить _vagrant up_.

Если установки прервалась по другим причинам может помочь запуск с ключом _--provision_.
По завершении установки будет запущена виртуальная машина с двумя пользователями:

![Alt text](4/Screenshot_1.jpg)

3. 1ое задание - Реализация базовой переадресации

В задании требуется настроить переадрисацию на свичах в топологии ниже:

![Alt text](3/Screenshot_2.jpg)

Для запуска тестовой среды нужно перейти в папу задания и запустить mininet:

    cd /home/p4/tutorials/exercises/basic
    make run

После запуска можно проверить, что пинги между устройствами не проходят:

    h1 ping h2
    pingall

![Alt text](3/Screenshot_3.jpg)

Чтобы выйти из mininet нужно написать _exit_. Для завершения mininet выполнить:

    make stop
    make clean

Топология сети храниться в json-файле в папке _pod-topo_:

![Alt text](3/Screenshot_4.jpg)

И каждому свичу соответсвует json-файл с правилами. Ниже правила на свича s1:

![Alt text](3/Screenshot_5.jpg)

Основная логика содержится в файле _basic.p4_.
В начале файла определяются стукутры и типы данных, в том числе ipv4_t и ethernet_t, которые являюстся полями в структуре headers.

![Alt text](3/Screenshot_8.jpg)

После идет парсер, который переводит заголовки из входящего пакетf в структуру headers. Сначала из пакета достается заголовок etherntent с содержимым, и если поле etherType соответсвует номеру протокола ipv4, то достается и заголовок ipv4.

![Alt text](3/Screenshot_9.jpg)

Далее идут элементы панели управления: проверка чексуммы, действия над входящими пакетами, действия над выходящими пакетами, рассчет чексуммы и объединение в пакет.

Для задания достаточно дописать код для входящих пакетов и объединения в пакет.

Действия будут свершаться тольско с ipv4, так что, нужно проверять заголовок ipv4. После проверки происходит соотнесение адреса назначения из пакета с таблицей ipv4_lrm (скриншот правил для s1 выше), при совпадении выполняется действие, указанное в правилах, с параметрами, указанными там же. Действие для переадресации _ipv4_forward_ указывает порт для выхода, меняет mac-адрес источника на свой (который в пакете был указан как адрес назначения), а адрес назначения меняет на адрес, полученный из таблицы, также ttl пакета уменьшается на 1.

![Alt text](3/Screenshot_11.jpg)

В упаковщике по очереди упаковываюся заголовки:

![Alt text](3/Screenshot_14.jpg)

После снова запускается mininet, и проверяется пингами:

![Alt text](3/Screenshot_15.jpg)

Задание выполнено.

5. 2ое задание - Реализация базового тунеллирования


